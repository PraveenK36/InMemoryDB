version: '3.8'

services:
  zookeeper:
    image: zookeeper:3.8
    container_name: kvstore-zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zookeeper:2888:3888;2181
      ZOO_LOG4J_PROP: "WARN,CONSOLE"  # Only show WARN and ERROR
      ZOO_4LW_COMMANDS_WHITELIST: "*"
      ZOO_TICK_TIME: 2000
      ZOO_INIT_LIMIT: 10
      ZOO_SYNC_LIMIT: 5
    volumes:
      - zk-data:/data
      - zk-logs:/datalog
    networks:
      - kvstore-net
    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc localhost 2181 | grep imok"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  node-1:
    build: .
    container_name: kvstore-node-1
    ports:
      - "9001:9001"
      - "5006:5005"
    command: ["block-1", "kvstore-zookeeper:2181", "9001", "kvstore-node-2:9002"]
    environment:
      - JAVA_TOOL_OPTIONS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
      - ZK_CLIENT_LOG_LEVEL=ERROR
      - JVMFLAGS=-Dorg.slf4j.simpleLogger.defaultLogLevel=warn -Dorg.slf4j.simpleLogger.log.org.apache.zookeeper=error
    depends_on:
      zookeeper:
        condition: service_healthy
    networks:
      - kvstore-net
    restart: unless-stopped

  node-2:
    build: .
    container_name: kvstore-node-2
    ports:
      - "9002:9002"
    command: ["block-1", "kvstore-zookeeper:2181", "9002", "kvstore-node-1:9001"]
    environment:
      - JAVA_TOOL_OPTIONS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
      - ZK_CLIENT_LOG_LEVEL=ERROR
      - JVMFLAGS=-Dorg.slf4j.simpleLogger.defaultLogLevel=warn -Dorg.slf4j.simpleLogger.log.org.apache.zookeeper=error
    depends_on:
      zookeeper:
        condition: service_healthy
    networks:
      - kvstore-net
    restart: unless-stopped

  node-3:
    build: .
    container_name: kvstore-node-3
    ports:
      - "9003:9003"
    command: ["block-2", "kvstore-zookeeper:2181", "9003", "kvstore-node-4:9004"]
    depends_on:
      zookeeper:
        condition: service_healthy
    networks:
      - kvstore-net
    restart: unless-stopped

  node-4:
    build: .
    container_name: kvstore-node-4
    ports:
      - "9004:9004"
    command: ["block-2", "kvstore-zookeeper:2181", "9004", "kvstore-node-3:9003"]
    depends_on:
      zookeeper:
        condition: service_healthy
    networks:
      - kvstore-net
    restart: unless-stopped

  node-5:
    build: .
    container_name: kvstore-node-5
    ports:
      - "9005:9005"
    command: ["block-1", "kvstore-zookeeper:2181", "9005", "kvstore-node-3:9001,kvstore-node-3:9002"]
    depends_on:
      zookeeper:
        condition: service_healthy
    networks:
      - kvstore-net
    restart: unless-stopped

networks:
  kvstore-net:
    driver: bridge

volumes:
  zk-data:
  zk-logs:
